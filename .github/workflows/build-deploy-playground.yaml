name: Build and Deploy Playground

on:
  push:
    branches-ignore:
      - main  # Ignora la branca main
  pull_request:
    branches-ignore:
      - main  # Ignora la branca main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2


      - name: Set Vars
        run: |
          buildVersion=$(echo $GITHUB_REF_NAME)_$(echo $GITHUB_SHA | head -c7)
          echo "buildVersion=$buildVersion" >> "$GITHUB_ENV"
          PLAYGROUND_ENV=play-${GITHUB_REF_NAME:0:25}
          echo "PLAYGROUND_ENV=$PLAYGROUND_ENV" >> "$GITHUB_ENV"
          export BRANCH_DATABASE=`echo "$PLAYGROUND_ENV" | tr - _`
          echo "BRANCH_DATABASE=$PLAY_BRANCH_DATABASE" >> "$GITHUB_ENV"
          export BRANCH_HOSTNAME=$PLAYGROUND_ENV.pe.maulabs.cat
          echo "BRANCH_HOSTNAME=$BRANCH_HOSTNAME" >> "$GITHUB_ENV"

      - name: Get Vars
        run: export

      #          echo "PLAYGROUND_ENV=play-$(CI_COMMIT_REF_SLUG:0:25}


#  BRANCH_DATABASE=`echo "$PLAYGROUND_ENV" | tr - _`
#  POSTGRES_URI=$PLAYGROUND_PG/$BRANCH_DATABASE
#  REDIS_URI=$DEV_REDIS/${CI_COMMIT_REF_SLUG%%-*}
#  BRANCH_HOSTNAME=$PLAYGROUND_ENV.p.mycircutor.com
#  DYNAMIC_ENVIRONMENT_URL=https://$BRANCH_HOSTNAME

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}


      - name: Build the Docker image
        run: |
          make build-api VERSION=$buildVersion

      - name: Log in to DigitalOcean Container Registry with short-lived credentials
        run: doctl registry login --expiry-seconds 1200

      - name: Push the Docker image
        run: make push-api VERSION=$buildVersion

      - name: Run a multi-line script
        run: |
          export
